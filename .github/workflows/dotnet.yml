# Build and package RemoteRelay for multiple platforms
# Server: linux-arm64 (Raspberry Pi)
# Client: win-x64, linux-x64, linux-arm64

name: .NET Build

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_call:  # Allows this workflow to be called by other workflows

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    # ======== Server Build (linux-arm64 only) ========
    - name: Publish Server - linux-arm64
      run: |
        dotnet publish RemoteRelay.Server/RemoteRelay.Server.csproj \
          --configuration Release \
          --runtime linux-arm64 \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:PublishTrimmed=false \
          -o ./publish/server-linux-arm64

    # ======== Server Build (linux-arm) ========
    - name: Publish Server - linux-arm
      run: |
        dotnet publish RemoteRelay.Server/RemoteRelay.Server.csproj \
          --configuration Release \
          --runtime linux-arm \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:PublishTrimmed=false \
          -o ./publish/server-linux-arm

    # ======== Client Builds (multi-platform) ========
    - name: Publish Client - win-x64
      run: |
        dotnet publish RemoteRelay/RemoteRelay.csproj \
          --configuration Release \
          --runtime win-x64 \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:PublishTrimmed=false \
          -o ./publish/client-win-x64

    - name: Publish Client - linux-x64
      run: |
        dotnet publish RemoteRelay/RemoteRelay.csproj \
          --configuration Release \
          --runtime linux-x64 \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:PublishTrimmed=false \
          -o ./publish/client-linux-x64

    - name: Publish Client - linux-arm64
      run: |
        dotnet publish RemoteRelay/RemoteRelay.csproj \
          --configuration Release \
          --runtime linux-arm64 \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:PublishTrimmed=false \
          -o ./publish/client-linux-arm64

    - name: Publish Client - linux-arm
      run: |
        dotnet publish RemoteRelay/RemoteRelay.csproj \
          --configuration Release \
          --runtime linux-arm \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:PublishTrimmed=false \
          -o ./publish/client-linux-arm

    # ======== Upload Artifacts ========
    - name: Upload Server - linux-arm64
      uses: actions/upload-artifact@v4
      with:
        name: RemoteRelay-Server-linux-arm64
        path: ./publish/server-linux-arm64

    - name: Upload Server - linux-arm
      uses: actions/upload-artifact@v4
      with:
        name: RemoteRelay-Server-linux-arm
        path: ./publish/server-linux-arm

    - name: Upload Client - win-x64
      uses: actions/upload-artifact@v4
      with:
        name: RemoteRelay-Client-win-x64
        path: ./publish/client-win-x64

    - name: Upload Client - linux-x64
      uses: actions/upload-artifact@v4
      with:
        name: RemoteRelay-Client-linux-x64
        path: ./publish/client-linux-x64

    - name: Upload Client - linux-arm64
      uses: actions/upload-artifact@v4
      with:
        name: RemoteRelay-Client-linux-arm64
        path: ./publish/client-linux-arm64

    - name: Upload Client - linux-arm
      uses: actions/upload-artifact@v4
      with:
        name: RemoteRelay-Client-linux-arm
        path: ./publish/client-linux-arm

    # ======== Makeself Installers ========
    - name: Install makeself
      run: sudo apt-get update && sudo apt-get install -y makeself

    - name: Create makeself installers
      run: |
        chmod +x create_makeself_installer.sh
        
        # Generate for linux-arm64
        ./create_makeself_installer.sh linux-arm64
        
        # Generate for linux-arm
        ./create_makeself_installer.sh linux-arm

    - name: Upload Makeself Installer - linux-arm64
      uses: actions/upload-artifact@v4
      with:
        name: RemoteRelay-Installer-linux-arm64
        path: ./remote-relay-installer-linux-arm64.sh

    - name: Upload Makeself Installer - linux-arm
      uses: actions/upload-artifact@v4
      with:
        name: RemoteRelay-Installer-linux-arm
        path: ./remote-relay-installer-linux-arm.sh
